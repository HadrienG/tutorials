



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>Metabarcoding - Bioinformatics Tutorials</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#e91e63">
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="pink" data-md-color-accent="pink">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#metabarcoding" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Bioinformatics Tutorials" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Bioinformatics Tutorials
              </span>
              <span class="md-header-nav__topic">
                Metabarcoding
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/HadrienG/tutorials/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      HadrienG/tutorials
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Bioinformatics Tutorials" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Bioinformatics Tutorials
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/HadrienG/tutorials/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      HadrienG/tutorials
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Individual lessons
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Individual lessons
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../command_line/" title="The command-line" class="md-nav__link">
      The command-line
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../file_formats/" title="File Formats" class="md-nav__link">
      File Formats
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../qc/" title="Quality Control and Trimming" class="md-nav__link">
      Quality Control and Trimming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mapping/" title="Mapping and Variant Calling" class="md-nav__link">
      Mapping and Variant Calling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../assembly/" title="De-novo Genome Assembly" class="md-nav__link">
      De-novo Genome Assembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../annotation/" title="Genome Annotation" class="md-nav__link">
      Genome Annotation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pan_genome/" title="Pan-Genome Analysis" class="md-nav__link">
      Pan-Genome Analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../16S/" title="Metabarcoding" class="md-nav__link">
      Metabarcoding
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../wms/" title="Whole Metagenome Sequencing" class="md-nav__link">
      Whole Metagenome Sequencing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../meta_assembly/" title="Metagenome assembly" class="md-nav__link">
      Metagenome assembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../meta_assembly_2/" title="Metagenome assembly (continued)" class="md-nav__link">
      Metagenome assembly (continued)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rna/" title="RNA-Seq" class="md-nav__link">
      RNA-Seq
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nanopore/" title="Introduction to Nanopore Sequencing" class="md-nav__link">
      Introduction to Nanopore Sequencing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" title="Table of Contents" class="md-nav__link">
    Table of Contents
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#softwares-required-for-this-tutorial" title="Softwares Required for this Tutorial" class="md-nav__link">
    Softwares Required for this Tutorial
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading-the-data-and-start-mothur" title="Downloading the Data and Start Mothur" class="md-nav__link">
    Downloading the Data and Start Mothur
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reducing-sequencing-and-pcr-errors" title="Reducing Sequencing and PCR Errors" class="md-nav__link">
    Reducing Sequencing and PCR Errors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processing-improved-sequences" title="Processing Improved Sequences" class="md-nav__link">
    Processing Improved Sequences
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysis" title="Analysis" class="md-nav__link">
    Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#otus" title="OTUs" class="md-nav__link">
    OTUs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#batch-mode" title="Batch Mode" class="md-nav__link">
    Batch Mode
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phyloseq-analysis" title="PhyloSeq Analysis" class="md-nav__link">
    PhyloSeq Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ordination-and-distance-based-analysis" title="Ordination and distance-based analysis" class="md-nav__link">
    Ordination and distance-based analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alpha-diversity-graphics" title="Alpha diversity graphics" class="md-nav__link">
    Alpha diversity graphics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trees" title="Trees" class="md-nav__link">
    Trees
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bar-plots" title="Bar plots" class="md-nav__link">
    Bar plots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heatmaps" title="Heatmaps" class="md-nav__link">
    Heatmaps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot-microbiome-network" title="Plot microbiome network" class="md-nav__link">
    Plot microbiome network
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/HadrienG/tutorials/edit/master/docs/16S_mothur.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="metabarcoding">Metabarcoding<a class="headerlink" href="#metabarcoding" title="Permanent link">&para;</a></h1>
<p>This tutorial is largely inspired of the <a href="http://www.mothur.org/wiki/MiSeq_SOP">MiSeq SOP</a> from the Schloss Lab.</p>
<blockquote>
<p>Kozich JJ, Westcott SL, Baxter NT, Highlander SK, Schloss PD. (2013): Development of a dual-index sequencing strategy and curation pipeline for analyzing amplicon sequence data on the MiSeq Illumina sequencing platform. Applied and Environmental Microbiology. 79(17):5112-20.</p>
</blockquote>
<h3 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#softwares-required-for-this-tutorial">Softwares Required for this Tutorial</a></li>
<li><a href="#downloading-the-data-and-start-mothur">Downloading the Data and Start Mothur</a></li>
<li><a href="#reducing-sequencing-and-pcr-errors">Reducing Sequencing and PCR Errors</a></li>
<li><a href="#processing-improved-sequences">Processing Improved Sequences</a></li>
<li><a href="#analysis">Analysis</a><ul>
<li><a href="#otus">OTUs</a></li>
</ul>
</li>
<li><a href="#batch-mode">Batch Mode</a></li>
</ul>
<h3 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h3>
<p>The 16S rRNA gene is a section of prokaryotic DNA found in all bacteria and archaea. This gene codes for an rRNA, and this rRNA in turn makes up part of the ribosome. The first 'r' in rRNA stands for ribosomal. The ribosome is composed of two subunits, the large subunit (LSU) and the small subunit (SSU).</p>
<p>The 16S rRNA gene is a commonly used tool for identifying bacteria for several reasons.  First, traditional characterization depended upon phenotypic traits like gram positive or gram negative, bacillus or coccus, etc. Taxonomists today consider analysis of an organism's DNA more reliable than classification based solely on phenotypes. Secondly, researchers may, for a number of reasons, want to identify or classify only the bacteria within a given environmental or medical sample.  While there is a homologous gene in eukaryotes, the 18S rRNA gene, it is distinct, thereby rendering the 16S rRNA gene a useful tool for extracting and identifying bacteria as separate from plant, animal, fungal, and protist DNA within the same sample.  Thirdly, the 16S rRNA gene is relatively short at 1.5 kb, making it faster and cheaper to sequence than many other unique bacterial genes.</p>
<p>Mothur is a command-line computer program for analyzing sequence data from microbial communities and namely 16s data. mothur is licensed under the GPL and is free to use.</p>
<h3 id="softwares-required-for-this-tutorial">Softwares Required for this Tutorial<a class="headerlink" href="#softwares-required-for-this-tutorial" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="http://www.mothur.org">mothur</a></li>
<li><a href="https://github.com/accaldwell/mothur_krona">mothur_krona</a></li>
</ul>
<h3 id="downloading-the-data-and-start-mothur">Downloading the Data and Start Mothur<a class="headerlink" href="#downloading-the-data-and-start-mothur" title="Permanent link">&para;</a></h3>
<p>Firstly, download and unzip the sample dataset:</p>
<div class="codehilite"><pre><span></span>wget http://www.mothur.org/w/images/d/d6/MiSeqSOPData.zip
unzip MiSeqSOPData.zip
</pre></div>


<p>In the <code>MiSeq_SOP</code> directory, you'll find the reads files in fastq format, as well as a file called <code>stability.files</code></p>
<p>The first lines of <code>stability.files</code> look like this:</p>
<blockquote>
<p>F3D0  F3D0_S188_L001_R1_001.fastq F3D0_S188_L001_R2_001.fastq
F3D141  F3D141_S207_L001_R1_001.fastq   F3D141_S207_L001_R2_001.fastq
F3D142  F3D142_S208_L001_R1_001.fastq   F3D142_S208_L001_R2_001.fastq
F3D143  F3D143_S209_L001_R1_001.fastq   F3D143_S209_L001_R2_001.fastq</p>
</blockquote>
<p>The first column is the name of the sample. The second column is the name of the forward read for that sample and the third columns in the name of the reverse read for that sample.</p>
<p>Now it's time to start mothur. Type <code>mothur</code> in your terminal. You should see your prompt changing to</p>
<blockquote>
<p>mothur &gt;</p>
</blockquote>
<h3 id="reducing-sequencing-and-pcr-errors">Reducing Sequencing and PCR Errors<a class="headerlink" href="#reducing-sequencing-and-pcr-errors" title="Permanent link">&para;</a></h3>
<p>The first thing we want to do is combine our two sets of reads for each sample and then to combine the data from all of the samples. This is done using the <code>make.contigs</code> command, which requires <code>stability.files</code> as input. This command will extract the sequence and quality score data from your fastq files, create the reverse complement of the reverse read and then join the reads into contigs.</p>
<div class="codehilite"><pre><span></span>make.contigs(file=stability.files, processors=8)  

It took 30 secs to process 152360 sequences.  

Group count:
F3D0    7793
F3D1    5869
F3D141  5958
F3D142  3183
F3D143  3178
F3D144  4827
F3D145  7377
F3D146  5021
F3D147  17070
F3D148  12405
F3D149  13083
F3D150  5509
F3D2    19620
F3D3    6758
F3D5    4448
F3D6    7989
F3D7    5129
F3D8    5294
F3D9    7070
Mock    4779

Total of all groups is 152360

Output File Names:
stability.trim.contigs.fasta
stability.trim.contigs.qual
stability.contigs.report
stability.scrap.contigs.fasta
stability.scrap.contigs.qual
stability.contigs.groups
</pre></div>


<p>The <code>stability.contigs.report</code> file will tell you something about the contig assembly for each read. Let's see what these sequences look like using the <code>summary.seqs</code> command:</p>
<div class="codehilite"><pre><span></span>summary.seqs(fasta=stability.trim.contigs.fasta)

Start   End NBases  Ambigs  Polymer NumSeqs
Minimum:    1   248 248 0   3   1
2.5%-tile:  1   252 252 0   3   3810
25%-tile:   1   252 252 0   4   38091
Median:     1   252 252 0   4   76181
75%-tile:   1   253 253 0   5   114271
97.5%-tile: 1   253 253 6   6   148552
Maximum:    1   502 502 249 243 152360
Mean:   1   252.811 252.811 0.70063 4.44854
# of Seqs:  152360
</pre></div>


<p>This tells us that we have 152360 sequences that for the most part vary between 248 and 253 bases. Interestingly, the longest read in the dataset is 502 bp. Be suspicious of this, the reads are supposed to be 251 bp each. This read clearly didn't assemble well (or at all). Also, note that at least 2.5% of our sequences had some ambiguous base calls. We'll take care of these issues in the next step when we run <code>screen.seqs</code>.</p>
<p><code>screen.seqs(fasta=stability.trim.contigs.fasta, group=stability.contigs.groups, maxambig=0, maxlength=275)</code></p>
<p>You'll notice that mothur remembered that we used 8 processors in <code>make.contigs</code>. To see what else mothur knows about you, run the following:</p>
<div class="codehilite"><pre><span></span>get.current()

Current files saved by mothur:
fasta=stability.trim.contigs.good.fasta
group=stability.contigs.good.groups
qfile=stability.trim.contigs.qual
processors=8
summary=stability.trim.contigs.summary
</pre></div>


<p>What this means is that mothur remembers your latest fasta file and group file as well as the number of processors you have. So you could run:</p>
<div class="codehilite"><pre><span></span>mothur &gt; summary.seqs(fasta=stability.trim.contigs.good.fasta)
mothur &gt; summary.seqs(fasta=current)
mothur &gt; summary.seqs()
</pre></div>


<p>and get the same output for each command.</p>
<p>But, now that we have filtered the sequencing errors, let's move to the next step.</p>
<h3 id="processing-improved-sequences">Processing Improved Sequences<a class="headerlink" href="#processing-improved-sequences" title="Permanent link">&para;</a></h3>
<p>We anticipate that many of our sequences are duplicates of each other. Because it's computationally wasteful to align the same sequences several times, we'll make our sequences unique:</p>
<div class="codehilite"><pre><span></span>unique.seqs(fasta=stability.trim.contigs.good.fasta)
</pre></div>


<p>If two sequences have the same identical sequence, then they're considered duplicates and will get merged. In the screen output there are two columns - the first is the number of sequences characterized and the second is the number of unique sequences remaining</p>
<p>Another thing to do to make our lives easier is to simplify the names and group files. If you look at the most recent versions of those files you'll see together they are 13 MB. This may not seem like much, but with a full MiSeq run those long sequence names can add up and make life tedious. So we'll run count.seqs to generate a table where the rows are the names of the unique seqeunces and the columns are the names of the groups. The table is then filled with the number of times each unique sequence shows up in each group.</p>
<p>This will generate a file called stability.trim.contigs.good.count_table. In subsequent commands we'll use it by using the count option:</p>
<div class="codehilite"><pre><span></span>count.seqs(name=stability.trim.contigs.good.names, group=stability.contigs.good.groups)
summary.seqs(count=stability.trim.contigs.good.count_table)

Using stability.trim.contigs.good.unique.fasta as input file for the fasta parameter.

Using 8 processors.

        Start   End NBases  Ambigs  Polymer NumSeqs
Minimum:    1   250 250 0   3   1
2.5%-tile:  1   252 252 0   3   3227
25%-tile:   1   252 252 0   4   32265
Median:     1   252 252 0   4   64530
75%-tile:   1   253 253 0   5   96794
97.5%-tile: 1   253 253 0   6   125832
Maximum:    1   270 270 0   12  129058
Mean:   1   252.462 252.462 0   4.36663
# of unique seqs:   16477
total # of seqs:    129058
</pre></div>


<p>Now we need to align our sequences to the reference alignment.</p>
<p>First we need to download the SILVA database.</p>
<div class="codehilite"><pre><span></span># This step should be done outside mothur
wget http://www.mothur.org/w/images/9/98/Silva.bacteria.zip
unzip Silva.bacteria.zip
</pre></div>


<p>If you have quit mothur to download the database, rerun the <code>mothur</code> command, then take a look at the database you have downloaded:</p>
<div class="codehilite"><pre><span></span>summary.seqs(fasta=silva.bacteria/silva.bacteria.fasta, processors=8)
</pre></div>


<p>Now do the alignment using <code>align.seqs</code>:</p>
<div class="codehilite"><pre><span></span>align.seqs(fasta=stability.trim.contigs.good.unique.fasta, reference=silva.bacteria/silva.bacteria.fasta)
</pre></div>


<p>We can then run <code>summary.seqs</code> again to get a summary of our alignment:</p>
<div class="codehilite"><pre><span></span>summary.seqs(fasta=stability.trim.contigs.good.unique.align, count=stability.trim.contigs.good.count_table)
</pre></div>


<p>You'll see that the bulk of the sequences start at position 13862 and end at position 23444. Some sequences start at position 13144 or 13876 and end at 22587 or 25294. These deviants from the mode positions are likely due to an insertion or deletion at the terminal ends of the aliignments. Sometimes you'll see sequences that start and end at the same position indicating a very poor alignment, which is generally due to non-specific amplification. To make sure that everything overlaps the same region we'll re-run screen.seqs to get sequences that start at or before position 1968 and end at or after position 11550. We'll also set the maximum homopolymer length to 8 since there's nothing in the database with a stretch of 9 or more of the same base in a row (this really could have been done in the first execution of screen.seqs above). Note that we need the count table so that we can update the table for the sequences we're removing and we're also using the summary file so we don't have to figure out again all the start and stop positions:</p>
<div class="codehilite"><pre><span></span>screen.seqs(fasta=stability.trim.contigs.good.unique.align, count=stability.trim.contigs.good.count_table, summary=stability.trim.contigs.good.unique.summary, start=13862, end=23444, maxhomop=8)
summary.seqs(fasta=current, count=current)
</pre></div>


<p>No we can trim both ends of the aligned reads to be sure the all overlap exactly the same region. We can do this with <code>fliter.seqs</code></p>
<div class="codehilite"><pre><span></span>filter.seqs(fasta=stability.trim.contigs.good.unique.good.align, vertical=T, trump=.)
</pre></div>


<p>We may have introduced redundancy by trimming the ends of the sequences, so we will re-run <code>unique.seqs</code></p>
<div class="codehilite"><pre><span></span>unique.seqs(fasta=stability.trim.contigs.good.unique.good.filter.fasta, count=stability.trim.contigs.good.good.count_table)
</pre></div>


<p>This identified 3 duplicate sequences that we've now merged with previous unique sequences. The next thing we want to do to further de-noise our sequences is to pre-cluster the sequences using the <code>pre.cluster</code> command allowing for up to 2 differences between sequences. This command will split the sequences by group and then sort them by abundance and go from most abundant to least and identify sequences that are within 2 nt of each other. If they are then they get merged. We generally favor allowing 1 difference for every 100 bp of sequence:</p>
<div class="codehilite"><pre><span></span>pre.cluster(fasta=stability.trim.contigs.good.unique.good.filter.unique.fasta, count=stability.trim.contigs.good.unique.good.filter.count_table, diffs=2)
</pre></div>


<p>At this point we have removed as much sequencing error as we can and it is time to turn our attention to removing chimeras. We'll do this using the UCHIME algorithm that is called within mothur using the <code>chimera.uchime</code> command. Again, this command will split the data by sample and check for chimeras. Our preferred way of doing this is to use the abundant sequences as our reference. In addition, if a sequence is flagged as chimeric in one sample, the the default (dereplicate=F) is to remove it from all samples. Our experience suggests that this is a bit aggressive since we've seen rare sequences get flagged as chimeric when they're the most abundant sequence in another sample. This is how we do it:</p>
<div class="codehilite"><pre><span></span>chimera.uchime(fasta=stability.trim.contigs.good.unique.good.filter.unique.precluster.fasta, count=stability.trim.contigs.good.unique.good.filter.unique.precluster.count_table, dereplicate=t)
</pre></div>


<p>Running <code>chimera.uchime</code> with the count file will remove the chimeric sequences from the count file. But you still need to remove those sequences from the fasta file. We do this using <code>remove.seqs</code>:</p>
<div class="codehilite"><pre><span></span>remove.seqs(fasta=stability.trim.contigs.good.unique.good.filter.unique.precluster.fasta, accnos=stability.trim.contigs.good.unique.good.filter.unique.precluster.denovo.uchime.accnos)
</pre></div>


<p>As a final quality control step, we need to see if there are any "undesirables" in our dataset. Sometimes when we pick a primer set they will amplify other stuff that gets to this point in the pipeline such as 18S rRNA gene fragments or 16S rRNA from Archaea, chloroplasts, and mitochondira. There's also just the random stuff that we want to get rid of.  Let's go ahead and classify those sequences using the Bayesian classifier with the <code>classify.seqs</code> command:</p>
<div class="codehilite"><pre><span></span><span class="nb">classify</span>.<span class="n">seqs</span>(<span class="n">fasta</span>=<span class="n">stability</span>.<span class="nb">trim</span>.<span class="n">contigs</span>.<span class="n">good</span>.<span class="n">unique</span>.<span class="n">good</span>.<span class="n">filter</span>.<span class="n">unique</span>.<span class="n">precluster</span>.<span class="nb">pick</span>.<span class="n">fasta</span>, <span class="nb">count</span>=<span class="n">stability</span>.<span class="nb">trim</span>.<span class="n">contigs</span>.<span class="n">good</span>.<span class="n">unique</span>.<span class="n">good</span>.<span class="n">filter</span>.<span class="n">unique</span>.<span class="n">precluster</span>.<span class="n">denovo</span>.<span class="n">uchime</span>.<span class="nb">pick</span>.<span class="n">count_table</span>, <span class="n">reference</span>=<span class="n">silva</span>.<span class="n">bacteria</span><span class="o">/</span><span class="n">silva</span>.<span class="n">bacteria</span>.<span class="n">fasta</span>, <span class="n">taxonomy</span>=<span class="n">silva</span>.<span class="n">bacteria</span><span class="o">/</span><span class="n">silva</span>.<span class="n">bacteria</span>.<span class="n">rdp</span>.<span class="n">tax</span>, <span class="n">cutoff</span>=<span class="mi">80</span>)
</pre></div>


<p>Now that everything is classified we want to remove our undesirables. We do this with the <code>remove.lineage</code> command:</p>
<div class="codehilite"><pre><span></span>remove.lineage(fasta=stability.trim.contigs.good.unique.good.filter.unique.precluster.pick.fasta, count=stability.trim.contigs.good.unique.good.filter.unique.precluster.denovo.uchime.pick.count_table, taxonomy=stability.trim.contigs.good.unique.good.filter.unique.precluster.pick.rdp.wang.taxonomy, taxon=Chloroplast-Mitochondria-unknown-Archaea-Eukaryota)
</pre></div>


<h3 id="analysis">Analysis<a class="headerlink" href="#analysis" title="Permanent link">&para;</a></h3>
<h4 id="otus">OTUs<a class="headerlink" href="#otus" title="Permanent link">&para;</a></h4>
<p>We will use <code>cluster.split</code> for clustering sequences into OTUs</p>
<div class="codehilite"><pre><span></span>cluster.split(fasta=stability.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.fasta, count=stability.trim.contigs.good.unique.good.filter.unique.precluster.denovo.uchime.pick.pick.count_table, taxonomy=stability.trim.contigs.good.unique.good.filter.unique.precluster.pick.rdp.wang.pick.taxonomy, splitmethod=classify, taxlevel=4, cutoff=0.15)
</pre></div>


<p>We used <code>taxlevel=4</code>, which corresponds to the level of <code>Order</code></p>
<p>Next we want to know how many sequences are in each OTU from each group and we can do this using the <code>make.shared command</code>. Here we tell mothur that we're really only interested in the 0.03 cutoff level:</p>
<div class="codehilite"><pre><span></span>make.shared(list=stability.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.an.unique_list.list, count=stability.trim.contigs.good.unique.good.filter.unique.precluster.denovo.uchime.pick.pick.count_table, label=0.03)
</pre></div>


<p>We also want to know the taxonomy for each of our OTUs. We can get the consensus taxonomy for each OTU using the <code>classify.otu</code> command</p>
<div class="codehilite"><pre><span></span><span class="nb">classify</span>.<span class="n">otu</span>(<span class="n">list</span>=<span class="n">stability</span>.<span class="nb">trim</span>.<span class="n">contigs</span>.<span class="n">good</span>.<span class="n">unique</span>.<span class="n">good</span>.<span class="n">filter</span>.<span class="n">unique</span>.<span class="n">precluster</span>.<span class="nb">pick</span>.<span class="nb">pick</span>.<span class="n">an</span>.<span class="n">unique_list</span>.<span class="n">list</span>, <span class="nb">count</span>=<span class="n">stability</span>.<span class="nb">trim</span>.<span class="n">contigs</span>.<span class="n">good</span>.<span class="n">unique</span>.<span class="n">good</span>.<span class="n">filter</span>.<span class="n">unique</span>.<span class="n">precluster</span>.<span class="n">denovo</span>.<span class="n">uchime</span>.<span class="nb">pick</span>.<span class="nb">pick</span>.<span class="n">count_table</span>, <span class="n">taxonomy</span>=<span class="n">stability</span>.<span class="nb">trim</span>.<span class="n">contigs</span>.<span class="n">good</span>.<span class="n">unique</span>.<span class="n">good</span>.<span class="n">filter</span>.<span class="n">unique</span>.<span class="n">precluster</span>.<span class="nb">pick</span>.<span class="n">rdp</span>.<span class="n">wang</span>.<span class="nb">pick</span>.<span class="n">taxonomy</span>, <span class="n">label</span>=<span class="mf">0.03</span>)
</pre></div>


<p>If you open the file <code>stability.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.an.unique_list.0.03.cons.taxonomy</code>, you can get information about your OTUs.</p>
<div class="codehilite"><pre><span></span>OTU Size    Taxonomy
Otu0001 12328   Bacteria(100);Bacteroidetes(100);Bacteroidia(100);Bacteroidales(100);Porphyromonadaceae(100);Barnesiella(100);Barnesiella_unclassified(100);
Otu0002 8918    Bacteria(100);Bacteroidetes(100);Bacteroidia(100);Bacteroidales(100);Porphyromonadaceae(100);Barnesiella(100);Barnesiella_unclassified(100);
Otu0003 7850    Bacteria(100);Bacteroidetes(100);Bacteroidia(100);Bacteroidales(100);Porphyromonadaceae(100);Barnesiella(100);Barnesiella_unclassified(100);
Otu0004 7478    Bacteria(100);Bacteroidetes(100);Bacteroidia(100);Bacteroidales(100);Porphyromonadaceae(100);Barnesiella(100);Barnesiella_unclassified(100);
Otu0005 7478    Bacteria(100);Bacteroidetes(100);Bacteroidia(100);Bacteroidales(100);Porphyromonadaceae(100);Barnesiella(100);Barnesiella_unclassified(100);
Otu0006 6650    Bacteria(100);Bacteroidetes(100);Bacteroidia(100);Bacteroidales(100);Porphyromonadaceae(100);Barnesiella(100);Barnesiella_unclassified(100);
Otu0007 6341    Bacteria(100);Bacteroidetes(100);Bacteroidia(100);Bacteroidales(100);Bacteroidaceae(100);Bacteroides(100);Bacteroides_unclassified(100);
Otu0008 5374    Bacteria(100);Bacteroidetes(100);Bacteroidia(100);Bacteroidales(100);Rikenellaceae(100);Alistipes(100);Alistipes_unclassified(100);
Otu0009 3618    Bacteria(100);Bacteroidetes(100);Bacteroidia(100);Bacteroidales(100);Porphyromonadaceae(100);Barnesiella(100);Barnesiella_unclassified(100);
</pre></div>


<p>This is telling you that Otu0001 was observed 12328 times in your sample and that 100% of the sequences were from <em>Barnesiella</em></p>
<!-- We'll visualize the composition of our datasets using Krona.

wzxhzdk:23


Now open `xml.krona.html` in your browser! -->

<p>In order to vizualise the composition of our datasets, we'll use phyloseq, a R package to work with microbiom data.</p>
<p>Most of the phyloseq functionalities require aand a tree file. We need to generate it with mothur:</p>
<div class="codehilite"><pre><span></span>dist.seqs(fasta=stability.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.fasta, output=lt, processors=8)
clearcut(phylip=stability.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.phylip.dist)
</pre></div>


<h3 id="batch-mode">Batch Mode<a class="headerlink" href="#batch-mode" title="Permanent link">&para;</a></h3>
<p>It is perfectly acceptable to enter the commands for your analysis from within mothur. We call this the interactive mode. If you are doing a lot these types of analysis or you want to use this SOP on your own data without thinking too much, you can run mothur in <code>batch mode</code> using</p>
<p><code>./mothur script.batch</code></p>
<p>where script.batch (or whatever name you want, really) is a text file containing all the
commands that you previously entered in interactive mode.</p>
<p>If you have time, copy all the commands from this tutorial in a file, a try to make mothur work in batch mode!</p>
<h3 id="phyloseq-analysis">PhyloSeq Analysis<a class="headerlink" href="#phyloseq-analysis" title="Permanent link">&para;</a></h3>
<p>First, install and load the phyloseq package:</p>
<div class="codehilite"><pre><span></span><span class="nf">source</span><span class="p">(</span><span class="s">&#39;http://bioconductor.org/biocLite.R&#39;</span><span class="p">)</span>
<span class="nf">biocLite</span><span class="p">(</span><span class="s">&#39;phyloseq&#39;</span><span class="p">)</span>

<span class="nf">library</span><span class="p">(</span><span class="s">&quot;phyloseq&quot;</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="s">&quot;ggplot2&quot;</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="s">&quot;plyr&quot;</span><span class="p">)</span>
<span class="nf">theme_set</span><span class="p">(</span><span class="nf">theme_bw</span><span class="p">())</span>  <span class="c1"># set the ggplot theme</span>
</pre></div>


<p>The PhyloSeq package has an <code>import_mothur</code> function that you can use to import the files you generated with mothur. As an example, import the example mothur data provided by phyloseq as an example:</p>
<div class="codehilite"><pre><span></span><span class="n">mothlist</span> <span class="o">&lt;-</span> <span class="nf">system.file</span><span class="p">(</span><span class="s">&quot;extdata&quot;</span><span class="p">,</span> <span class="s">&quot;esophagus.fn.list.gz&quot;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s">&quot;phyloseq&quot;</span><span class="p">)</span>
<span class="n">mothgroup</span> <span class="o">&lt;-</span> <span class="nf">system.file</span><span class="p">(</span><span class="s">&quot;extdata&quot;</span><span class="p">,</span> <span class="s">&quot;esophagus.good.groups.gz&quot;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s">&quot;phyloseq&quot;</span><span class="p">)</span>
<span class="n">mothtree</span> <span class="o">&lt;-</span> <span class="nf">system.file</span><span class="p">(</span><span class="s">&quot;extdata&quot;</span><span class="p">,</span> <span class="s">&quot;esophagus.tree.gz&quot;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s">&quot;phyloseq&quot;</span><span class="p">)</span>

<span class="nf">show_mothur_cutoffs</span><span class="p">(</span><span class="n">mothlist</span><span class="p">)</span>
<span class="n">cutoff</span> <span class="o">&lt;-</span> <span class="s">&#39;0.10&#39;</span>
<span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">import_mothur</span><span class="p">(</span><span class="n">mothlist</span><span class="p">,</span> <span class="n">mothgroup</span><span class="p">,</span> <span class="n">mothtree</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
<span class="n">x</span>
</pre></div>


<p>Note: If if you ever work with 16s data and decide to use QIIME instead of mothur, phyloseq also has an <code>import_qiime</code> function. Also, newer version of qiime and mothur have the ability to produce a <code>.biom</code> file.</p>
<blockquote>
<p>“The biom file format (canonically pronounced ‘biome’) is designed to be a general-use format for representing counts of observations in one or more biological samples. BIOM is a recognized standard for the Earth Microbiome Project and is a Genomics Standards Consortium candidate project.”</p>
</blockquote>
<p>More info on <a href="http://biom-format.org/">http://biom-format.org/</a></p>
<p>For the rest of this tutorial, we will work with an example dataset provided by the phyloseq package. Load the data with the following command:</p>
<div class="codehilite"><pre><span></span><span class="nf">data</span><span class="p">(</span><span class="n">enterotype</span><span class="p">)</span>
<span class="nf">data</span><span class="p">(</span><span class="s">&quot;GlobalPatterns&quot;</span><span class="p">)</span>
</pre></div>


<h4 id="ordination-and-distance-based-analysis">Ordination and distance-based analysis<a class="headerlink" href="#ordination-and-distance-based-analysis" title="Permanent link">&para;</a></h4>
<p>Let's do some preliminary filtering. Remove the OTUs that included all unassigned sequences ("-1")</p>
<div class="codehilite"><pre><span></span><span class="n">enterotype</span> <span class="o">&lt;-</span> <span class="nf">subset_species</span><span class="p">(</span><span class="n">enterotype</span><span class="p">,</span> <span class="n">Genus</span> <span class="o">!=</span> <span class="s">&quot;-1&quot;</span><span class="p">)</span>
</pre></div>


<p>The available distance methods coded in the phyloseq package:</p>
<div class="codehilite"><pre><span></span><span class="n">dist_methods</span> <span class="o">&lt;-</span> <span class="nf">unlist</span><span class="p">(</span><span class="n">distanceMethodList</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">dist_methods</span><span class="p">)</span>

<span class="c1">##     UniFrac1     UniFrac2        DPCoA          JSD     vegdist1</span>
<span class="c1">##    &quot;unifrac&quot;   &quot;wunifrac&quot;      &quot;dpcoa&quot;        &quot;jsd&quot;  &quot;manhattan&quot;</span>
<span class="c1">##     vegdist2     vegdist3     vegdist4     vegdist5     vegdist6</span>
<span class="c1">##  &quot;euclidean&quot;   &quot;canberra&quot;       &quot;bray&quot; &quot;kulczynski&quot;    &quot;jaccard&quot;</span>
<span class="c1">##     vegdist7     vegdist8     vegdist9    vegdist10    vegdist11</span>
<span class="c1">##      &quot;gower&quot;   &quot;altGower&quot;   &quot;morisita&quot;       &quot;horn&quot;  &quot;mountford&quot;</span>
<span class="c1">##    vegdist12    vegdist13    vegdist14    vegdist15   betadiver1</span>
<span class="c1">##       &quot;raup&quot;   &quot;binomial&quot;       &quot;chao&quot;        &quot;cao&quot;          &quot;w&quot;</span>
<span class="c1">##   betadiver2   betadiver3   betadiver4   betadiver5   betadiver6</span>
<span class="c1">##         &quot;-1&quot;          &quot;c&quot;         &quot;wb&quot;          &quot;r&quot;          &quot;I&quot;</span>
<span class="c1">##   betadiver7   betadiver8   betadiver9  betadiver10  betadiver11</span>
<span class="c1">##          &quot;e&quot;          &quot;t&quot;         &quot;me&quot;          &quot;j&quot;        &quot;sor&quot;</span>
<span class="c1">##  betadiver12  betadiver13  betadiver14  betadiver15  betadiver16</span>
<span class="c1">##          &quot;m&quot;         &quot;-2&quot;         &quot;co&quot;         &quot;cc&quot;          &quot;g&quot;</span>
<span class="c1">##  betadiver17  betadiver18  betadiver19  betadiver20  betadiver21</span>
<span class="c1">##         &quot;-3&quot;          &quot;l&quot;         &quot;19&quot;         &quot;hk&quot;        &quot;rlb&quot;</span>
<span class="c1">##  betadiver22  betadiver23  betadiver24        dist1        dist2</span>
<span class="c1">##        &quot;sim&quot;         &quot;gl&quot;          &quot;z&quot;    &quot;maximum&quot;     &quot;binary&quot;</span>
<span class="c1">##        dist3   designdist</span>
<span class="c1">##  &quot;minkowski&quot;        &quot;ANY&quot;</span>
</pre></div>


<p>Remove the two distance-methods that require a tree, and the generic custom method that requires user-defined distance arguments.</p>
<div class="codehilite"><pre><span></span><span class="c1"># These require tree</span>
<span class="n">dist_methods</span><span class="nf">[</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)</span><span class="n">]</span>

<span class="c1"># Remove them from the vector</span>
<span class="n">dist_methods</span> <span class="o">&lt;-</span> <span class="n">dist_methods[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)</span><span class="n">]</span>
<span class="c1"># This is the user-defined method:</span>
<span class="n">dist_methods[</span><span class="s">&quot;designdist&quot;</span><span class="n">]</span>

<span class="c1"># Remove the user-defined distance</span>
<span class="n">dist_methods</span> <span class="o">=</span> <span class="n">dist_methods[</span><span class="o">-</span><span class="nf">which</span><span class="p">(</span><span class="n">dist_methods</span><span class="o">==</span><span class="s">&quot;ANY&quot;</span><span class="p">)</span><span class="n">]</span>
</pre></div>


<p>Loop through each distance method, save each plot to a list, called plist.</p>
<div class="codehilite"><pre><span></span><span class="n">plist</span> <span class="o">&lt;-</span> <span class="nf">vector</span><span class="p">(</span><span class="s">&quot;list&quot;</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">dist_methods</span><span class="p">))</span>
<span class="nf">names</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span> <span class="o">=</span> <span class="n">dist_methods</span>
<span class="nf">for</span><span class="p">(</span> <span class="n">i</span> <span class="n">in</span> <span class="n">dist_methods</span> <span class="p">){</span>
    <span class="c1"># Calculate distance matrix</span>
    <span class="n">iDist</span> <span class="o">&lt;-</span> <span class="nf">distance</span><span class="p">(</span><span class="n">enterotype</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># Calculate ordination</span>
    <span class="n">iMDS</span>  <span class="o">&lt;-</span> <span class="nf">ordinate</span><span class="p">(</span><span class="n">enterotype</span><span class="p">,</span> <span class="s">&quot;MDS&quot;</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">iDist</span><span class="p">)</span>
    <span class="c1">## Make plot</span>
    <span class="c1"># Don&#39;t carry over previous plot (if error, p will be blank)</span>
    <span class="n">p</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
    <span class="c1"># Create plot, store as temp variable, p</span>
    <span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">plot_ordination</span><span class="p">(</span><span class="n">enterotype</span><span class="p">,</span> <span class="n">iMDS</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;SeqTech&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s">&quot;Enterotype&quot;</span><span class="p">)</span>
    <span class="c1"># Add title to each plot</span>
    <span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;MDS using distance method &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="c1"># Save the graphic to file.</span>
    <span class="n">plist[[i]]</span> <span class="o">=</span> <span class="n">p</span>
<span class="p">}</span>
</pre></div>


<p>Combine results and shade according to Sequencing technology:</p>
<div class="codehilite"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="nf">ldply</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">x</span><span class="o">$</span><span class="n">data</span><span class="p">)</span>
<span class="nf">names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="n">[1]</span> <span class="o">&lt;-</span> <span class="s">&quot;distance&quot;</span>
<span class="n">p</span> <span class="o">=</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">Axis.1</span><span class="p">,</span> <span class="n">Axis.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">SeqTech</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">Enterotype</span><span class="p">))</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">distance</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s">&quot;free&quot;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&quot;MDS on various distance metrics for Enterotype dataset&quot;</span><span class="p">)</span>
<span class="n">p</span>
</pre></div>


<p>Print individual plots:</p>
<div class="codehilite"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">plist[[</span><span class="s">&quot;jsd&quot;</span><span class="n">]]</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">plist[[</span><span class="s">&quot;jaccard&quot;</span><span class="n">]]</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">plist[[</span><span class="s">&quot;bray&quot;</span><span class="n">]]</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">plist[[</span><span class="s">&quot;euclidean&quot;</span><span class="n">]]</span><span class="p">)</span>
</pre></div>


<h4 id="alpha-diversity-graphics">Alpha diversity graphics<a class="headerlink" href="#alpha-diversity-graphics" title="Permanent link">&para;</a></h4>
<p>Here is the default graphic produced by the plot_richness function on the GP example dataset:</p>
<div class="codehilite"><pre><span></span><span class="n">GP</span> <span class="o">&lt;-</span> <span class="nf">prune_species</span><span class="p">(</span><span class="nf">speciesSums</span><span class="p">(</span><span class="n">GlobalPatterns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">,</span> <span class="n">GlobalPatterns</span><span class="p">)</span>
<span class="nf">plot_richness</span><span class="p">(</span><span class="n">GP</span><span class="p">)</span>
</pre></div>


<p>Note that in this case, the Fisher calculation results in a warning (but still plots). We can avoid this by specifying a measures argument to plot_richness, which will include just the alpha-diversity measures that we want.</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_richness</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Chao1&quot;</span><span class="p">,</span> <span class="s">&quot;Shannon&quot;</span><span class="p">))</span>
</pre></div>


<p>We can specify a sample variable on which to group/organize samples along the horizontal (x) axis. An experimentally meaningful categorical variable is usually a good choice – in this case, the "SampleType" variable works much better than attempting to interpret the sample names directly (as in the previous plot):</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_richness</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">&quot;SampleType&quot;</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Chao1&quot;</span><span class="p">,</span> <span class="s">&quot;Shannon&quot;</span><span class="p">))</span>
</pre></div>


<p>Now suppose we wanted to use an external variable in the plot that isn’t in the GP dataset already – for example, a logical that indicated whether or not the samples are human-associated. First, define this new variable, human, as a factor (other vectors could also work; or other data you might have describing the samples).</p>
<div class="codehilite"><pre><span></span><span class="nf">sampleData</span><span class="p">(</span><span class="n">GP</span><span class="p">)</span><span class="o">$</span><span class="n">human</span> <span class="o">&lt;-</span> <span class="nf">getVariable</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="s">&quot;SampleType&quot;</span><span class="p">)</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Feces&quot;</span><span class="p">,</span> <span class="s">&quot;Mock&quot;</span><span class="p">,</span> <span class="s">&quot;Skin&quot;</span><span class="p">,</span> <span class="s">&quot;Tongue&quot;</span><span class="p">)</span>
</pre></div>


<p>Now tell plot_richness to map the new human variable on the horizontal axis, and shade the points in different color groups, according to which "SampleType" they belong.</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_richness</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">&quot;human&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;SampleType&quot;</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Chao1&quot;</span><span class="p">,</span> <span class="s">&quot;Shannon&quot;</span><span class="p">))</span>
</pre></div>


<p>We can merge samples that are from the environment (SampleType), and make the points bigger with a ggplot2 layer. First, merge the samples.</p>
<div class="codehilite"><pre><span></span><span class="n">GPst</span> <span class="o">=</span> <span class="nf">merge_samples</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="s">&quot;SampleType&quot;</span><span class="p">)</span>
<span class="c1"># repair variables that were damaged during merge (coerced to numeric)</span>
<span class="nf">sample_data</span><span class="p">(</span><span class="n">GPst</span><span class="p">)</span><span class="o">$</span><span class="n">SampleType</span> <span class="o">&lt;-</span> <span class="nf">factor</span><span class="p">(</span><span class="nf">sample_names</span><span class="p">(</span><span class="n">GPst</span><span class="p">))</span>
<span class="nf">sample_data</span><span class="p">(</span><span class="n">GPst</span><span class="p">)</span><span class="o">$</span><span class="n">human</span> <span class="o">&lt;-</span> <span class="nf">as.logical</span><span class="p">(</span><span class="nf">sample_data</span><span class="p">(</span><span class="n">GPst</span><span class="p">)</span><span class="o">$</span><span class="n">human</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="nf">plot_richness</span><span class="p">(</span><span class="n">GPst</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">&quot;human&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;SampleType&quot;</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Chao1&quot;</span><span class="p">,</span> <span class="s">&quot;Shannon&quot;</span><span class="p">))</span>
<span class="n">p</span> <span class="o">+</span> <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.7</span><span class="p">)</span>
</pre></div>


<h4 id="trees">Trees<a class="headerlink" href="#trees" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="nf">head</span><span class="p">(</span><span class="nf">phy_tree</span><span class="p">(</span><span class="n">GlobalPatterns</span><span class="p">)</span><span class="o">$</span><span class="n">node.label</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
</pre></div>


<p>The node data from the <code>GlobalPatterns</code> dataset are strange. They look like they might be bootstrap values, but they sometimes have two decimals.</p>
<div class="codehilite"><pre><span></span><span class="nf">phy_tree</span><span class="p">(</span><span class="n">GlobalPatterns</span><span class="p">)</span><span class="o">$</span><span class="n">node.label</span> <span class="o">=</span> <span class="nf">substr</span><span class="p">(</span><span class="nf">phy_tree</span><span class="p">(</span><span class="n">GlobalPatterns</span><span class="p">)</span><span class="o">$</span><span class="n">node.label</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
</pre></div>


<p>Additionally, the dataset has many OTUs, too many to fit them all on a tree. Let's take the 50 more abundant and plot a basic tree:</p>
<div class="codehilite"><pre><span></span><span class="n">physeq</span> <span class="o">=</span> <span class="nf">prune_taxa</span><span class="p">(</span><span class="nf">taxa_names</span><span class="p">(</span><span class="n">GlobalPatterns</span><span class="p">)</span><span class="n">[1</span><span class="o">:</span><span class="m">50</span><span class="n">]</span><span class="p">,</span> <span class="n">GlobalPatterns</span><span class="p">)</span>
<span class="nf">plot_tree</span><span class="p">(</span><span class="n">physeq</span><span class="p">)</span>
</pre></div>


<p>dots are annotated next to tips (OTUs) in the tree, one for each sample in which that OTU was observed. Let's color the dots by taxonomic ranks, and sample covariates:</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_tree</span><span class="p">(</span><span class="n">physeq</span><span class="p">,</span> <span class="n">nodelabf</span><span class="o">=</span><span class="nf">nodeplotboot</span><span class="p">(),</span> <span class="n">ladderize</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;SampleType&quot;</span><span class="p">)</span>
</pre></div>


<p>by taxonomic class:</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_tree</span><span class="p">(</span><span class="n">physeq</span><span class="p">,</span> <span class="n">nodelabf</span><span class="o">=</span><span class="nf">nodeplotboot</span><span class="p">(),</span> <span class="n">ladderize</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;Class&quot;</span><span class="p">)</span>
</pre></div>


<p>It can be useful to label the tips:</p>
<div class="codehilite"><pre><span></span>plot_tree(physeq, color=&quot;SampleType&quot;, label.tips=&quot;Genus&quot;)
</pre></div>


<p>Making a radial tree is easy with ggplot2, simply recognizing that our vertically-oriented tree is a cartesian mapping of the data to a graphic – and that a radial tree is the same mapping, but with polar coordinates instead.</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_tree</span><span class="p">(</span><span class="n">physeq</span><span class="p">,</span> <span class="n">nodelabf</span><span class="o">=</span><span class="nf">nodeplotboot</span><span class="p">(</span><span class="m">60</span><span class="p">,</span><span class="m">60</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;SampleType&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s">&quot;Class&quot;</span><span class="p">,</span> <span class="n">ladderize</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">coord_polar</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
</pre></div>


<h4 id="bar-plots">Bar plots<a class="headerlink" href="#bar-plots" title="Permanent link">&para;</a></h4>
<p>Bar plots are one of the easiest way to vizualize your data. But be careful, they can be misleading if grouping sample!</p>
<p>Let's take a subset of the GlobalPatterns dataset, and produce a basic bar plot:</p>
<div class="codehilite"><pre><span></span><span class="n">gp.ch</span> <span class="o">=</span> <span class="nf">subset_taxa</span><span class="p">(</span><span class="n">GlobalPatterns</span><span class="p">,</span> <span class="n">Phylum</span> <span class="o">==</span> <span class="s">&quot;Chlamydiae&quot;</span><span class="p">)</span>
<span class="nf">plot_bar</span><span class="p">(</span><span class="n">gp.ch</span><span class="p">)</span>
</pre></div>


<p>The dataset is plotted with every sample mapped individually to the horizontal (x) axis, and abundance values mapped to the veritcal (y) axis. At each sample’s horizontal position, the abundance values for each OTU are stacked in order from greatest to least, separate by a thin horizontal line. As long as the parameters you choose to separate the data result in more than one OTU abundance value at the respective position in the plot, the values will be stacked in order as a means of displaying both the sum total value while still representing the individual OTU abundances.</p>
<p>The bar plot will be clearer with color to represent the Genus to which each OTU belongs.</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_bar</span><span class="p">(</span><span class="n">gp.ch</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&quot;Genus&quot;</span><span class="p">)</span>
</pre></div>


<p>Now keep the same fill color, and group the samples together by the SampleType variable; essentially, the environment from which the sample was taken and sequenced.</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_bar</span><span class="p">(</span><span class="n">gp.ch</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">&quot;SampleType&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&quot;Genus&quot;</span><span class="p">)</span>
</pre></div>


<p>A more complex example using facets:</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_bar</span><span class="p">(</span><span class="n">gp.ch</span><span class="p">,</span> <span class="s">&quot;Family&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&quot;Genus&quot;</span><span class="p">,</span> <span class="n">facet_grid</span><span class="o">=~</span><span class="n">SampleType</span><span class="p">)</span>
</pre></div>


<h4 id="heatmaps">Heatmaps<a class="headerlink" href="#heatmaps" title="Permanent link">&para;</a></h4>
<p>The following two lines subset the dataset to just the top 300 most abundant Bacteria taxa across all samples (in this case, with no prior preprocessing. Not recommended, but quick).</p>
<div class="codehilite"><pre><span></span><span class="nf">data</span><span class="p">(</span><span class="s">&quot;GlobalPatterns&quot;</span><span class="p">)</span>
<span class="n">gpt</span> <span class="o">&lt;-</span> <span class="nf">subset_taxa</span><span class="p">(</span><span class="n">GlobalPatterns</span><span class="p">,</span> <span class="n">Kingdom</span><span class="o">==</span><span class="s">&quot;Bacteria&quot;</span><span class="p">)</span>
<span class="n">gpt</span> <span class="o">&lt;-</span> <span class="nf">prune_taxa</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="nf">sort</span><span class="p">(</span><span class="nf">taxa_sums</span><span class="p">(</span><span class="n">gpt</span><span class="p">),</span><span class="kc">TRUE</span><span class="p">)</span><span class="n">[1</span><span class="o">:</span><span class="m">300</span><span class="n">]</span><span class="p">),</span> <span class="n">gpt</span><span class="p">)</span>
<span class="nf">plot_heatmap</span><span class="p">(</span><span class="n">gpt</span><span class="p">,</span> <span class="n">sample.label</span><span class="o">=</span><span class="s">&quot;SampleType&quot;</span><span class="p">)</span>
</pre></div>


<p>subset a smaller dataset based on an Archaeal phylum</p>
<div class="codehilite"><pre><span></span><span class="n">gpac</span> <span class="o">&lt;-</span> <span class="nf">subset_taxa</span><span class="p">(</span><span class="n">GlobalPatterns</span><span class="p">,</span> <span class="n">Phylum</span><span class="o">==</span><span class="s">&quot;Crenarchaeota&quot;</span><span class="p">)</span>
<span class="nf">plot_heatmap</span><span class="p">(</span><span class="n">gpac</span><span class="p">)</span>
</pre></div>


<h4 id="plot-microbiome-network">Plot microbiome network<a class="headerlink" href="#plot-microbiome-network" title="Permanent link">&para;</a></h4>
<p>There is a random aspect to some of the network layout methods. For complete reproducibility of the images produced later in this tutorial, it is possible to set the random number generator seed explicitly:</p>
<p><code>set.seed(711L)</code></p>
<p>Because we want to use the enterotype designations as a plot feature in these plots, we need to remove the 9 samples for which no enterotype designation was assigned (this will save us the hassle of some pesky warning messages, but everything still works; the offending samples are anyway omitted).</p>
<div class="codehilite"><pre><span></span><span class="n">enterotype</span> <span class="o">=</span> <span class="nf">subset_samples</span><span class="p">(</span><span class="n">enterotype</span><span class="p">,</span> <span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Enterotype</span><span class="p">))</span>
</pre></div>


<p>Create an igraph-based network based on the default distance method, “Jaccard”, and a maximum distance between connected nodes of 0.3.</p>
<div class="codehilite"><pre><span></span><span class="n">ig</span> <span class="o">&lt;-</span> <span class="nf">make_network</span><span class="p">(</span><span class="n">enterotype</span><span class="p">,</span> <span class="n">max.dist</span><span class="o">=</span><span class="m">0.3</span><span class="p">)</span>
<span class="nf">plot_network</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">enterotype</span><span class="p">)</span>
</pre></div>


<p>The previous graphic displayed some interesting structure, with one or two major subgraphs comprising a majority of samples. Furthermore, there seemed to be a correlation in the sample naming scheme and position within the network. Instead of trying to read all of the sample names to understand the pattern, let’s map some of the sample variables onto this graphic as color and shape:</p>
<div class="codehilite"><pre><span></span><span class="nf">plot_network</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">enterotype</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;SeqTech&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s">&quot;Enterotype&quot;</span><span class="p">,</span> <span class="n">line_weight</span><span class="o">=</span><span class="m">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">NULL</span><span class="p">)</span>
</pre></div>


<p>In the previous examples, the choice of maximum-distance and distance method were informed, but arbitrary. Let’s see what happens when the maximum distance is lowered, decreasing the number of edges in the network</p>
<div class="codehilite"><pre><span></span><span class="n">ig</span> <span class="o">&lt;-</span> <span class="nf">make_network</span><span class="p">(</span><span class="n">enterotype</span><span class="p">,</span> <span class="n">max.dist</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>
<span class="nf">plot_network</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">enterotype</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;SeqTech&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s">&quot;Enterotype&quot;</span><span class="p">,</span> <span class="n">line_weight</span><span class="o">=</span><span class="m">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">NULL</span><span class="p">)</span>
</pre></div>


<p>Let’s repeat the previous exercise, but replace the Jaccard (default) distance method with Bray-Curtis</p>
<div class="codehilite"><pre><span></span><span class="n">ig</span> <span class="o">&lt;-</span> <span class="nf">make_network</span><span class="p">(</span><span class="n">enterotype</span><span class="p">,</span> <span class="n">dist.fun</span><span class="o">=</span><span class="s">&quot;bray&quot;</span><span class="p">,</span> <span class="n">max.dist</span><span class="o">=</span><span class="m">0.3</span><span class="p">)</span>
<span class="nf">plot_network</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">enterotype</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;SeqTech&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s">&quot;Enterotype&quot;</span><span class="p">,</span> <span class="n">line_weight</span><span class="o">=</span><span class="m">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">NULL</span><span class="p">)</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/HadrienG" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/HGourle" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>